<script>
(function () {
  const input = document.getElementById('pokemonInput');
  const buscarBtn = document.getElementById('buscarBtn');
  const clearBtn = document.getElementById('clearBtn');
  const screen = document.getElementById('screen');
  const screenContainer = document.getElementById('screenContainer');
  const btnAudioEl = document.getElementById('btnAudio');

  let speech = null, paused = false, currentParagraphIndex = 0, paragraphs = [], paragraphElements = [];

  function esc(s){ return s ? String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""; }
  function splitText(text){ return text ? text.replace(/[*\/]/g,"").split(/\n+/).map(l=>l.trim()).filter(l=>l) : []; }

  function organize(text){
    const paras = splitText(text);
    const sections = {};
    paras.forEach(p=>{
      const m=p.match(/^([^:]{2,40}):\s*(.*)$/);
      if(m){
        let tag = m[1].trim();
        if(tag.toLowerCase().includes("ataques recomendados")) tag="Ataques";
        const content = m[2].trim();
        if(!sections[tag]) sections[tag]=[];
        sections[tag].push(content);
      } else {
        if(!sections["Informaci√≥n"]) sections["Informaci√≥n"]=[];
        sections["Informaci√≥n"].push(p);
      }
    });
    // Evitar vac√≠os
    Object.keys(sections).forEach(tag=>{
      sections[tag] = sections[tag].filter(line=>line.trim());
      if(sections[tag].length===0) sections[tag]=["Informaci√≥n no disponible"];
    });
    const out = [];
    Object.keys(sections).forEach(tag=>{ if(sections[tag] && sections[tag].length) out.push({tag, text: sections[tag].join(" ")}); });
    const html = out.map(s=>`<p><span class="tag">${esc(s.tag)}</span> ${esc(s.text)}</p>`).join("");
    const parasForTTS = out.map(s=>s.tag+": "+s.text); // etiquetas tambi√©n se leen
    return {html, parasForTTS};
  }

  function showLoading(name){
    if(speech && window.speechSynthesis) window.speechSynthesis.cancel();
    screen.innerHTML=`<p>üîé Buscando informaci√≥n sobre <strong>${esc(name)}</strong>...</p>`;
    btnAudioEl.style.display="none";
    btnAudioEl.classList.remove("speaking");
    btnAudioEl.style.border="2px solid transparent";
  }

  function showError(msg){
    screen.innerHTML=`<p>‚ùå ${esc(msg)}</p>`;
    btnAudioEl.style.display="none";
    btnAudioEl.classList.remove("speaking");
    btnAudioEl.style.border="2px solid transparent";
  }

  async function buscarPokemon(nombre){
    if(!nombre) return;
    showLoading(nombre);
    try {
      const resp = await fetch("/api/proxy", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({pokemon:nombre})});
      if(!resp.ok){ showError("Error en el servidor: "+resp.status); return; }
      const data = await resp.json();
      if(data.error || !data.respuesta){ showError(data.error||"No se recibi√≥ respuesta."); return; }

      const sprite = data.sprite || "";
      const organized = organize(data.respuesta);

      screen.innerHTML = (sprite?`<img src="${esc(sprite)}" alt="${esc(nombre)}" class="pokemon-img">`:"")+
                          `<h2 style="text-align:center; color:var(--accent)">${esc(nombre.toUpperCase())}</h2>`+
                          `<div id="resultado">${organized.html}</div>`;

      paragraphs = organized.parasForTTS;
      paragraphElements = Array.from(document.querySelectorAll("#resultado p"));
      currentParagraphIndex = 0;
      btnAudioEl.style.display = "block";
      btnAudioEl.classList.remove("speaking");
      btnAudioEl.style.border="2px solid transparent";
      speech=null;

    } catch(err){ console.error(err); showError("Error al conectar con el servidor."); }
  }

  buscarBtn.addEventListener("click", function(){
    const nombre=(input.value||"").trim().toLowerCase();
    if(!nombre){ alert("Ingresa un nombre de Pok√©mon"); return; }
    buscarPokemon(nombre);
  });

  input.addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); buscarBtn.click(); } });

  clearBtn.addEventListener("click", function(){
    input.value="";
    screen.innerHTML=`<p>üîç Escribe un nombre de Pok√©mon para comenzar.</p>`;
    btnAudioEl.style.display="none";
    btnAudioEl.classList.remove("speaking");
    btnAudioEl.style.border="2px solid transparent";
    paragraphs=[]; paragraphElements=[]; currentParagraphIndex=0; paused=false;
    if(speech && window.speechSynthesis) window.speechSynthesis.cancel();
  });

  if("speechSynthesis" in window && typeof SpeechSynthesisUtterance==="function"){
    btnAudioEl.addEventListener("click", function(){
      if(!paragraphs.length) return;
      const synth=window.speechSynthesis;
      if(synth.speaking || paused){
        if(!paused){ synth.pause(); paused=true; btnAudioEl.classList.remove("speaking"); btnAudioEl.style.border="2px solid transparent"; }
        else { synth.resume(); paused=false; btnAudioEl.classList.add("speaking"); btnAudioEl.style.border="2px solid #00f0ff"; }
      } else { currentParagraphIndex=0; speakNext(); }
    });
  } else btnAudioEl.style.display="none";

  function speakNext(){
    if(currentParagraphIndex >= paragraphs.length){
      btnAudioEl.classList.remove("speaking");
      btnAudioEl.style.border="2px solid transparent";
      currentParagraphIndex = 0;
      if(paragraphElements) paragraphElements.forEach(p=>p.classList.remove("highlight"));
      if(screenContainer) screenContainer.scrollTop=0;
      speech = null;
      return;
    }

    const paragraph = paragraphs[currentParagraphIndex];
    const u = new SpeechSynthesisUtterance(paragraph);
    u.lang = 'es-ES';

    // ‚úÖ Resaltado en tiempo real
    if(paragraphElements) paragraphElements.forEach(p=>p.classList.remove("highlight"));
    const currEl = paragraphElements[currentParagraphIndex];
    if(currEl){
      currEl.classList.add("highlight");
      currEl.scrollIntoView({behavior:"smooth", block:"center"});
    }

    u.onstart = () => {
      btnAudioEl.classList.add("speaking");
      btnAudioEl.style.border="2px solid #00f0ff";
    }

    u.onend = function(){ 
      currentParagraphIndex++; 
      speakNext(); 
    };

    speech = u; 
    window.speechSynthesis.speak(u);
    paused = false;
  }

})();
</script>
