<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PokeViewer</title>
  <style>
    :root{
      --bg: #0d1117;
      --card-red: #d62828;
      --screen: #222;
      --accent: #ffcc00;
      --muted: #9aa4b2;
      --text: #e6edf3;
      --glass: rgba(255,255,255,0.02);
      --border: #444;
    }

    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif;overflow:hidden;}
    body{display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box;}

    /* Wrapper */
    .wrapper{ width:100%; max-width:380px; }

    /* Title with bolts */
    .title-row { display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:12px; }
    .bolt {
      width:32px;height:32px;background:linear-gradient(180deg,#fff8b0,#ffcc00);
      clip-path: polygon(35% 0%, 60% 0%, 40% 55%, 70% 55%, 30% 100%, 40% 60%, 10% 60%);
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.5));
      opacity:0.9;
    }
    .title {
      font-size:1.7rem; font-weight:800; color:var(--accent); text-shadow:0 0 10px #ffcc0088;
      letter-spacing:0.6px;
    }
    @keyframes boltPulse { 0%{opacity:.18; transform:scale(.92) translateY(0);} 50%{opacity:1; transform:scale(1.06) translateY(-2px);} 100%{opacity:.28; transform:scale(.95) translateY(0);} }
    .bolt.left{ animation:boltPulse 2.2s ease-in-out infinite; animation-delay:0s; }
    .bolt.right{ animation:boltPulse 2.2s ease-in-out infinite; animation-delay:0.6s; }

    /* Pokedex card */
    .pokedex {
      background: var(--card-red);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      border: 2px solid rgba(0,0,0,0.35);
    }

    /* Screen */
    .screen-container {
      background: var(--screen);
      border-radius:10px;
      border:3px solid var(--border);
      padding:12px;
      min-height:300px;
      max-height:58vh;
      overflow:auto;
      box-sizing:border-box;
    }

    .pokemon-img { width:160px; height:160px; display:block; margin:10px auto; border-radius:8px; background:var(--glass); animation:float 2.2s ease-in-out infinite; }
    @keyframes float { 0%{transform:translateY(0);} 50%{transform:translateY(-8px);} 100%{transform:translateY(0);} }

    #resultado p { background: rgba(0,0,0,0.35); padding:8px; border-radius:8px; margin:8px 0; line-height:1.45; }
    .tag { color: #061; background: var(--accent); padding:3px 8px; border-radius:6px; font-weight:700; color:#0d1117; margin-right:8px; display:inline-block; }
    .highlight { background: rgba(255,204,0,0.10); border-radius:6px; transition:background .18s; }

    /* Controls */
    .controls { margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:center; }
    input[type="text"]{ padding:10px 12px; border-radius:8px; width:62%; border:none; text-align:center; outline:none; font-size:1rem; }
    .btnBuscar{ padding:10px 12px; border-radius:8px; background:var(--accent); color:#0d1117; border:none; font-weight:800; cursor:pointer; }
    .btnClear{ padding:10px 12px; border-radius:8px; background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.06); cursor:pointer; }
    .btnBuscar:active, .btnClear:active { transform: translateY(1px); }

    /* Audio button */
    #btnAudio { margin-top:10px; display:none; width:100%; padding:10px; border-radius:8px; background:#2a9d8f; border:none; color:white; cursor:pointer; font-weight:700; }
    #btnAudio.speaking { background:#e76f51; }

    /* Rayos decorativos - subtle */
    .rayo {
      position:fixed; top:-120px; width:2px; height:120px; background:linear-gradient(180deg,#0ff,transparent); opacity:.6;
      animation:caer 1.1s linear infinite;
    }
    .rayo.r1 { left:14%; animation-delay:0s; }
    .rayo.r2 { left:50%; animation-delay:0.35s; }
    .rayo.r3 { left:86%; animation-delay:0.65s; }
    @keyframes caer { 0%{ transform:translateY(-120px); opacity:0; } 50%{ opacity:1; } 100%{ transform:translateY(100vh); opacity:0; } }

    /* responsive */
    @media (max-width:420px) {
      .wrapper{ max-width:320px; }
      .pokemon-img{ width:140px; height:140px; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="title-row" aria-hidden="false">
      <div class="bolt left" aria-hidden="true"></div>
      <div class="title">PokeViewer</div>
      <div class="bolt right" aria-hidden="true"></div>
    </div>

    <div class="pokedex" role="main" aria-label="PokeViewer">
      <div class="screen-container">
        <div id="screen" class="screen" aria-live="polite">
          <p>üîç Escribe un nombre de Pok√©mon para comenzar.</p>
        </div>

        <button id="btnAudio" aria-label="Reproducir/Pausar audio">üîä Leer</button>
      </div>

      <div class="controls" role="search">
        <input id="pokemonInput" type="text" placeholder="Ej: Pikachu" aria-label="Nombre del Pok√©mon" />
        <button id="buscarBtn" class="btnBuscar" aria-label="Buscar">Buscar</button>
        <button id="clearBtn" class="btnClear" aria-label="Limpiar">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- subtle lightning decoration -->
  <div class="rayo r1"></div>
  <div class="rayo r2"></div>
  <div class="rayo r3"></div>

  <script>
  (function () {
    // Elements
    const input = document.getElementById('pokemonInput');
    const buscarBtn = document.getElementById('buscarBtn');
    const clearBtn = document.getElementById('clearBtn');
    const screen = document.getElementById('screen');
    const btnAudioEl = document.getElementById('btnAudio');

    let speech = null, paused = false, currentParagraphIndex = 0, paragraphs = [], paragraphElements = [];

    // Helper: escape
    function esc(s){ return s ? String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""; }

    // Split paragraphs
    function splitParagraphs(text) {
      if (!text) return [];
      return text.replace(/[\*\/]/g,"").split(/\n+/).map(p => p.trim()).filter(p => p);
    }

    // Organize & shorten the response into ordered sections
    const PREFERRED = ["Tipo","Fortalezas","Debilidades","Ataques recomendados","Ataques","Movimientos","Estrategia","Recomendaci√≥n"];

    function organize(text) {
      const paras = splitParagraphs(text);
      const sections = {};
      paras.forEach(p => {
        const m = p.match(/^([^:]{2,40}):\s*(.*)$/);
        if (m) {
          const tag = m[1].trim();
          const rest = m[2].trim();
          if (!sections[tag]) sections[tag] = [];
          sections[tag].push(rest);
        } else {
          if (!sections["Descripci√≥n"]) sections["Descripci√≥n"] = [];
          sections["Descripci√≥n"].push(p);
        }
      });

      const out = [];
      // prefer Description first
      if (sections["Descripci√≥n"]) {
        out.push({ tag: "Descripci√≥n", text: sections["Descripci√≥n"].slice(0,2).join(" ") });
        delete sections["Descripci√≥n"];
      }
      // preferred tags
      PREFERRED.forEach(tag => {
        if (sections[tag]) { out.push({ tag, text: sections[tag].join(" ") }); delete sections[tag]; }
      });
      // leftover
      Object.keys(sections).forEach(k => out.push({ tag: k, text: sections[k].join(" ") }));

      // limit length: keep first 5 sections and truncate texts to ~160 chars
      const limited = out.slice(0,5).map(s => ({ tag: s.tag, text: s.text.length>200 ? s.text.slice(0,197)+"‚Ä¶" : s.text }));
      // build html and paragraphs for TTS
      const html = limited.map(s => `<p><span class="tag">${esc(s.tag)}</span> ${esc(s.text)}</p>`).join("");
      const parasForTTS = limited.map(s => s.text);
      return { html, parasForTTS };
    }

    function showLoading(name){
      screen.innerHTML = "<p>üîé Buscando informaci√≥n sobre <strong>" + esc(name) + "</strong>...</p>";
      btnAudioEl.style.display = "none";
    }
    function showError(msg){
      screen.innerHTML = "<p>‚ùå " + esc(msg) + "</p>";
      btnAudioEl.style.display = "none";
    }

    // Main search using visor proxy
    async function buscarPokemon(nombre){
      if (!nombre) return;
      showLoading(nombre);

      try {
        const resp = await fetch("/api/proxy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pokemon: nombre })
        });

        if (!resp.ok) {
          const t = await resp.text().catch(()=>"");
          showError("Error en proxy: "+ (t || resp.status));
          return;
        }

        const data = await resp.json();
        if (data.error || !data.respuesta) {
          showError(data.error || "No se recibi√≥ respuesta de la IA.");
          return;
        }

        const sprite = data.sprite || "";
        const organized = organize(data.respuesta);

        // render
        screen.innerHTML = (sprite?`<img src="${esc(sprite)}" alt="${esc(nombre)}" class="pokemon-img">`:"") +
                           `<h2 style="text-align:center; color:${"--accent"}">${esc(nombre.toUpperCase())}</h2>` +
                           `<div id="resultado">${organized.html}</div>`;

        // prepare TTS
        paragraphs = organized.parasForTTS.length ? organized.parasForTTS : splitParagraphs(data.respuesta).slice(0,5);
        paragraphElements = document.querySelectorAll("#resultado p");
        currentParagraphIndex = 0;
        btnAudioEl.style.display = "block";
        btnAudioEl.classList.remove("speaking");
        speech = null;

      } catch (err) {
        console.error(err);
        showError("Error al conectar con el servidor proxy.");
      }
    }

    // Events
    buscarBtn.addEventListener("click", function () {
      const nombre = (input.value||"").trim().toLowerCase();
      if (!nombre) { alert("Ingresa un nombre de Pok√©mon"); return; }
      buscarPokemon(nombre);
    });

    input.addEventListener("keydown", function(e){
      if (e.key === "Enter") { e.preventDefault(); buscarBtn.click(); }
    });

    clearBtn.addEventListener("click", function(){
      input.value = "";
      screen.innerHTML = `<p>üîç Escribe un nombre de Pok√©mon para comenzar.</p>`;
      btnAudioEl.style.display = "none";
      paragraphs = []; paragraphElements = []; currentParagraphIndex = 0; paused = false;
      if (speech && window.speechSynthesis) window.speechSynthesis.cancel();
    });

    // TTS
    if ("speechSynthesis" in window && typeof SpeechSynthesisUtterance === "function") {
      btnAudioEl.addEventListener("click", function(){
        if (!paragraphs.length) return;
        const synth = window.speechSynthesis;
        if (synth.speaking || paused) {
          if (!paused) { synth.pause(); paused = true; btnAudioEl.classList.remove("speaking"); }
          else { synth.resume(); paused = false; btnAudioEl.classList.add("speaking"); }
        } else {
          currentParagraphIndex = 0; speakNext();
        }
      });
    } else {
      btnAudioEl.style.display = "none";
    }

    function speakNext(){
      if (currentParagraphIndex >= paragraphs.length) {
        btnAudioEl.classList.remove("speaking");
        currentParagraphIndex = 0;
        if (paragraphElements) paragraphElements.forEach(p=>p.classList.remove("highlight"));
        speech = null; return;
      }
      const paragraph = paragraphs[currentParagraphIndex];
      const u = new SpeechSynthesisUtterance(paragraph);
      u.lang = 'es-ES';
      if (paragraphElements) paragraphElements.forEach(p=>p.classList.remove('highlight'));
      const currEl = paragraphElements[currentParagraphIndex];
      if (currEl) { currEl.classList.add('highlight'); currEl.scrollIntoView({behavior:'smooth', block:'center'}); }
      u.onend = function(){ currentParagraphIndex++; speakNext(); };
      speech = u; window.speechSynthesis.speak(u);
      btnAudioEl.classList.add('speaking'); paused = false;
    }

    // expose
    window.buscarPokemon = function(nombre){ if(!nombre) return; buscarPokemon(String(nombre).toLowerCase()); };

    // polyfills if needed (AppCreator older webview)
    (function ensurePolyfills(){
      const need = (!window.fetch || !window.Promise || !window.TextDecoder || !window.TextEncoder);
      if (need) {
        const p = document.createElement('script'); p.src = "https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"; document.head.appendChild(p);
        const f = document.createElement('script'); f.src = "https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js"; document.head.appendChild(f);
      }
    })();

  })();
  </script>
</body>
</html>

