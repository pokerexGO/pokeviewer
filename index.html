<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PokeViewer</title>
<style>
/* ... TODO tu CSS existente ... */
</style>
</head>
<body>
<div class="wrapper">
  <div class="title-row">
    <div class="bolt left"></div>
    <div class="title">PokeViewer</div>
    <div class="bolt right"></div>
  </div>

  <div class="pokedex">
    <div class="screen-container" id="screenContainer">
      <div id="screen"><p>üîç Escribe un nombre de Pok√©mon para comenzar.</p></div>
    </div>

    <button id="btnAudio">üîä Leer</button>

    <div class="controls">
      <input id="pokemonInput" type="text" placeholder="Ej: Pikachu" />
      <button id="buscarBtn" class="btnBuscar">Buscar</button>
      <button id="clearBtn" class="btnClear">Limpiar</button>
    </div>
  </div>
</div>

<div class="rayo r1"></div>
<div class="rayo r2"></div>
<div class="rayo r3"></div>

<script>
(function(){
  const input = document.getElementById('pokemonInput');
  const buscarBtn = document.getElementById('buscarBtn');
  const clearBtn = document.getElementById('clearBtn');
  const screen = document.getElementById('screen');
  const btnAudioEl = document.getElementById('btnAudio');

  let paragraphs=[], paragraphElements=[], currentParagraphIndex=0;
  let audio=null, highlightInterval=null;

  function esc(s){ return s?String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""; }

  function splitText(text){ return text ? text.replace(/[*\/#]/g,"").split(/\n+/).map(l=>l.trim()).filter(l=>l) : []; }

  function organize(text){
    const paras = splitText(text);
    const sections = {};
    paras.forEach(p=>{
      const m=p.match(/^([^:]{2,40}):\s*(.*)$/);
      if(m){ 
        let tag = m[1].trim(); 
        if(tag.toLowerCase().includes("ataques")) tag="Ataques"; 
        const content = m[2].trim(); 
        if(!sections[tag]) sections[tag]=[]; 
        sections[tag].push(content); 
      } else { 
        if(!sections["Informaci√≥n"]) sections["Informaci√≥n"]=[]; 
        sections["Informaci√≥n"].push(p); 
      }
    });
    const out=[]; 
    Object.keys(sections).forEach(tag=>{ if(sections[tag].length) out.push({tag,text:sections[tag].join(" ")}); });
    const html = out.map(s=>`<p><span class="tag">${esc(s.tag)}</span> ${esc(s.text)}</p>`).join("");
    return {html, parasForTTS: out.map(s=>s.tag+": "+s.text)};
  }

  async function buscarPokemon(nombre){
    if(!nombre) return;
    screen.innerHTML=`<p>üîé Buscando informaci√≥n sobre <strong>${esc(nombre)}</strong>...</p>`;
    btnAudioEl.style.display="none";

    try{
      const resp = await fetch("/api/proxy", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({pokemon:nombre})
      });

      if(!resp.ok){ screen.innerHTML="<p>‚ùå Error en servidor</p>"; return; }

      const data = await resp.json();
      if(!data.respuesta){ screen.innerHTML="<p>‚ùå No se recibi√≥ respuesta</p>"; return; }

      const organized = organize(data.respuesta);
      screen.innerHTML = (data.sprite?`<img src="${esc(data.sprite)}" class="pokemon-img">`:"")+
                         `<h2>${esc(nombre.toUpperCase())}</h2>`+
                         `<div id="resultado">${organized.html}</div>`;

      paragraphs = organized.parasForTTS; 
      paragraphElements = Array.from(document.querySelectorAll("#resultado p"));
      currentParagraphIndex=0;
      btnAudioEl.style.display="block";

    }catch(e){
      console.error(e);
      screen.innerHTML="<p>‚ùå Error al buscar</p>";
    }
  }

  buscarBtn.onclick = ()=>{ 
    const n = input.value.trim(); 
    if(!n) return alert("Ingresa un nombre"); 
    buscarPokemon(n); 
  };

  clearBtn.onclick = ()=>{
    input.value="";
    screen.innerHTML="<p>üîç Escribe un nombre de Pok√©mon para comenzar.</p>";
    btnAudioEl.style.display="none";
    paragraphs=[];
    paragraphElements=[];
    currentParagraphIndex=0;
    if(audio) { audio.pause(); audio=null; }
    clearInterval(highlightInterval);
  };

  async function playAudioTTS(text){
    try{
      const resp = await fetch("/api/tts", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({text})
      });

      if(!resp.ok) throw new Error("TTS no disponible");

      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      if(audio){ audio.pause(); audio=null; clearInterval(highlightInterval); }

      audio = new Audio(url);
      audio.play();

      currentParagraphIndex=0;
      highlightInterval = setInterval(()=>{
        paragraphElements.forEach(p=>p.classList.remove("highlight"));
        if(currentParagraphIndex < paragraphElements.length){
          paragraphElements[currentParagraphIndex].classList.add("highlight");
        }
      }, 150);

      audio.onended = ()=>{ 
        paragraphElements.forEach(p=>p.classList.remove("highlight"));
        clearInterval(highlightInterval);
        currentParagraphIndex=0;
        audio=null;
      };

    }catch(e){
      console.error(e);
      alert("Audio no disponible en AppCreator24");
    }
  }

  btnAudioEl.addEventListener("click", ()=>{
    if(!paragraphs.length) return;
    const text = paragraphs.join(". ");
    playAudioTTS(text);
  });

})();
</script>
</body>
</html>
