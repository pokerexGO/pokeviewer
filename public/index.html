<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PokeViewer</title>
  <style>
    /* ... tu CSS existente sin cambios ... */
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="title-row">
      <div class="bolt left"></div>
      <div class="title">PokeViewer</div>
      <div class="bolt right"></div>
    </div>

    <div class="pokedex">
      <div class="screen-container" id="screenContainer">
        <div id="screen"><p>üîç Escribe un nombre de Pok√©mon para comenzar.</p></div>
      </div>

      <button id="btnAudio">üîä Leer</button>

      <div class="controls">
        <input id="pokemonInput" type="text" placeholder="Ej: Pikachu" />
        <button id="buscarBtn" class="btnBuscar">Buscar</button>
        <button id="clearBtn" class="btnClear">Limpiar</button>
      </div>
    </div>
  </div>

  <div class="rayo r1"></div>
  <div class="rayo r2"></div>
  <div class="rayo r3"></div>

  <script>
  (function(){
    const input = document.getElementById('pokemonInput');
    const buscarBtn = document.getElementById('buscarBtn');
    const clearBtn = document.getElementById('clearBtn');
    const screen = document.getElementById('screen');
    const screenContainer = document.getElementById('screenContainer');
    const btnAudioEl = document.getElementById('btnAudio');

    let paragraphs=[], paragraphElements=[], currentParagraphIndex=0;
    let speech=null, paused=false, highlightInterval=null;

    const isAppCreator = /appcreator24/i.test(navigator.userAgent);

    function esc(s){ return s?String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""; }

    function splitText(text){ return text ? text.replace(/[*\/#]/g,"").split(/\n+/).map(l=>l.trim()).filter(l=>l) : []; }

    function organize(text){
      const paras = splitText(text);
      const sections = {};
      paras.forEach(p=>{
        const m=p.match(/^([^:]{2,40}):\s*(.*)$/);
        if(m){
          let tag = m[1].trim();
          if(tag.toLowerCase().includes("ataques recomendados")) tag="Ataques";
          const content = m[2].trim();
          if(!sections[tag]) sections[tag]=[];
          sections[tag].push(content);
        } else {
          if(!sections["Informaci√≥n"]) sections["Informaci√≥n"]=[]; 
          sections["Informaci√≥n"].push(p);
        }
      });
      Object.keys(sections).forEach(tag=>{
        sections[tag]=sections[tag].filter(line=>line.trim());
        if(sections[tag].length===0) sections[tag]=["Informaci√≥n no disponible"];
      });
      const out=[];
      Object.keys(sections).forEach(tag=>{ if(sections[tag].length) out.push({tag,text:sections[tag].join(" ")}); });
      const html=out.map(s=>`<p><span class="tag">${esc(s.tag)}</span> ${esc(s.text)}</p>`).join("");
      const parasForTTS=out.map(s=>s.tag+": "+s.text);
      return {html,parasForTTS};
    }

    function showLoading(name){ screen.innerHTML=`<p>üîé Buscando informaci√≥n sobre <strong>${esc(name)}</strong>...</p>`; btnAudioEl.style.display="none"; }
    function showError(msg){ screen.innerHTML=`<p>‚ùå ${esc(msg)}</p>`; btnAudioEl.style.display="none"; }

    async function buscarPokemon(nombre){
      if(!nombre) return;
      showLoading(nombre);
      try{
        const resp = await fetch("/api/proxy", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({pokemon:nombre})});
        if(!resp.ok){ showError("Error en el servidor: "+resp.status); return; }
        const data = await resp.json();
        if(data.error || !data.respuesta){ showError(data.error||"No se recibi√≥ respuesta."); return; }

        const sprite = data.sprite||"";
        const organized = organize(data.respuesta);
        screen.innerHTML = (sprite?`<img src="${esc(sprite)}" alt="${esc(nombre)}" class="pokemon-img">`:"")+
                            `<h2 style="text-align:center; color:var(--accent)">${esc(nombre.toUpperCase())}</h2>`+
                            `<div id="resultado">${organized.html}</div>`;

        paragraphs = organized.parasForTTS;
        paragraphElements = Array.from(document.querySelectorAll("#resultado p"));
        btnAudioEl.style.display="block";
      }catch(err){ console.error("Error buscarPokemon:", err); showError("Error al conectar con el servidor."); }
    }

    buscarBtn.addEventListener("click", ()=>{ const nombre=input.value.trim().toLowerCase(); if(!nombre){alert("Ingresa un nombre de Pok√©mon");return;} buscarPokemon(nombre); });
    input.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); buscarBtn.click(); } });
    clearBtn.addEventListener("click", ()=>{ input.value=""; screen.innerHTML=`<p>üîç Escribe un nombre de Pok√©mon para comenzar.</p>`; btnAudioEl.style.display="none"; });

    // üîä Funci√≥n de lectura dual con logs
    btnAudioEl.addEventListener("click", async ()=>{
      if(!paragraphs.length) return;

      if(isAppCreator){
        try{
          const fullText = paragraphs.join(" ");
          console.log("[TTS] Texto a enviar:", fullText);
          btnAudioEl.textContent="üîä Generando audio...";
          const resp = await fetch("/api/audio",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:fullText})});
          console.log("[TTS] Respuesta HTTP:", resp.status, resp.statusText);
          const data = await resp.json();
          console.log("[TTS] JSON recibido:", data);

          if(data.url){
            console.log("[TTS] URL de audio:", data.url);
            const audio = new Audio(data.url);
            audio.addEventListener("canplaythrough", ()=>console.log("[TTS] Audio listo para reproducir"));
            audio.addEventListener("error", (e)=>console.error("[TTS] Error al reproducir audio:", e));
            btnAudioEl.textContent="üîä Reproduciendo...";
            audio.play().catch(err=>{ console.error("[TTS] Error al iniciar play():", err); btnAudioEl.textContent="‚ùå Error de reproducci√≥n"; });
            audio.onended=()=>{btnAudioEl.textContent="üîä Leer"; console.log("[TTS] Reproducci√≥n finalizada");};
          }else{
            btnAudioEl.textContent="‚ùå Error al generar el audio";
            console.error("[TTS] data.url no existe", data);
          }
        }catch(err){
          console.error("[TTS] Error al conectar con el TTS:", err);
          btnAudioEl.textContent="‚ùå Error al conectar con el TTS";
        }
        return;
      }

      if("speechSynthesis" in window && typeof SpeechSynthesisUtterance==="function"){
        const synth = window.speechSynthesis;
        if(synth.speaking){ synth.cancel(); btnAudioEl.classList.remove("speaking"); return; }
        currentParagraphIndex=0; speakNext();
      }
    });

    function speakNext(){
      if(currentParagraphIndex>=paragraphs.length){ window.speechSynthesis.cancel(); btnAudioEl.classList.remove("speaking"); return; }
      const text=paragraphs[currentParagraphIndex];
      const u=new SpeechSynthesisUtterance(text);
      u.lang='es-ES';
      btnAudioEl.classList.add("speaking");
      paragraphElements.forEach(p=>p.classList.remove("highlight"));
      paragraphElements[currentParagraphIndex].classList.add("highlight");
      paragraphElements[currentParagraphIndex].scrollIntoView({behavior:"smooth",block:"center"});
      window.speechSynthesis.speak(u);
      u.onend=()=>{ paragraphElements[currentParagraphIndex].classList.remove("highlight"); currentParagraphIndex++; speakNext(); };
    }

  })();
  </script>
</body>
</html>
